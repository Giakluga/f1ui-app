<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>F1 Query Interface</title>

    <!-- React + Babel + Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fade-in { from { opacity: 0 } to { opacity: 1 } }
        @keyframes slide-up { from { transform: translateY(10px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
        @keyframes trackMove {
            from { background-position: 0 0; }
            to { background-position: 40px 0; }
        }@keyframes gradientFlow {
             0% { background-position: 0% 50%; }
             50% { background-position: 100% 50%; }
             100% { background-position: 0% 50%; }
         }
        .bg-flow {
            margin: 0;
            background: linear-gradient(-45deg, #0f172a, #1e3a8a, #4f46e5, #9333ea);
            background-size: 300% 300%;
            animation: gradientFlow 8s ease infinite;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-slide {
            animation: fadeSlide 0.6s ease both;
        }
        @keyframes carMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(100%); }
        }

        @keyframes smokePuff {
            0% { opacity: 0.7; transform: scale(1) translateY(0); }
            50% { opacity: 0.5; transform: scale(1.5) translateY(-5px); }
            100% { opacity: 0; transform: scale(2) translateY(-10px); }
        }

        @keyframes smokeLoop {
            0%, 100% { opacity: 1; }
        }

        @keyframes smokePuff_2s_ease-in-out_infinite_1s {
            0%, 50% { opacity: 0; } 60%, 100% { opacity: 0.8; }
        }

        .animate-fade-in { animation: fade-in .35s ease both; }
        .animate-slide-up { animation: slide-up .35s ease both; }
    </style>
</head>
<body class="antialiased">
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    /* ======================= ICONS ======================= */
    const Icon = ({ path, className = "w-5 h-5" }) => (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d={path} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
        </svg>
    );
    const paths = {
        db: "M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4",
        play: "M5 3l14 9-14 9V3z",
        settings: "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37",
        sun: "M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.364-1.414-1.414M7.464 7.05 6.05 5.636m12.9 0L17.536 7.05M7.464 16.95 6.05 18.364M12 8a4 4 0 100 8 4 4 0 000-8z",
        moon: "M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z",
        trash: "M3 6h18M8 6V4h8v2m-1 0v13a2 2 0 01-2 2H9a2 2 0 01-2-2V6h10z",
        download: "M12 3v12m0 0l-4-4m4 4l4-4M5 21h14",
        upload: "M12 21v-12m0 0l-4 4m4-4l4 4M5 3h14",
        plus: "M12 5v14m-7-7h14",
        check: "M5 13l4 4L19 7",
        x: "M6 18L18 6M6 6l12 12",
        clock: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
        bolt: "M13 10V3L4 14h7v7l9-11h-7z",
        save: "M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
    };

    /* ======================= TOAST ======================= */
    function Toast({ message, type = "info", onClose }) {
        const style = type === "error"
            ? "bg-red-500/15 border-red-400 text-red-300"
            : type === "success"
                ? "bg-emerald-500/15 border-emerald-400 text-emerald-300"
                : "bg-blue-500/15 border-blue-400 text-blue-300";
        useEffect(() => {
            const t = setTimeout(() => onClose?.(), 2500);
            return () => clearTimeout(t);
        }, [onClose]);
        return (
            <div className={`fixed top-5 right-5 z-50 px-4 py-3 rounded-xl border shadow-lg backdrop-blur animate-slide-up ${style}`}>
                <div className="flex items-center gap-2">
                    <Icon path={type === "error" ? paths.x : type === "success" ? paths.check : paths.bolt} className="w-5 h-5"/>
                    <span className="text-sm">{message}</span>
                </div>
            </div>
        );
    }

    /* ======================= JSON CELL ======================= */
    function JsonCell({ value, dark }) {
        const text = useMemo(() => {
            try { return JSON.stringify(value, null, 2); } catch { return String(value); }
        }, [value]);
        return (
            <pre className={`text-xs rounded p-2 overflow-auto max-h-40 ${dark ? "bg-slate-900/60 text-slate-200" : "bg-gray-100 text-gray-800"}`}>
          {text}
        </pre>
        );
    }

    /* ======================= DEFAULT QUERIES ======================= */
    const defaultQueries = [
        {
            name: "Race Wins - Schumacher",
            query: "MATCH (d:Driver)-[rel:RESULTS_IN]-(r:Race)\n" +
                "WHERE d.forename = \"Michael\"\n" +
                "  AND d.surname = \"Schumacher\"\n" +
                "  AND rel.position = \"1\"\n" +
                "RETURN d.surname AS DRIVER, COUNT(rel) AS VICTORIES;",
            builtin: true
        },
        {
            name: "All time victories",
            query: "MATCH (d:Driver)-[rel:RESULTS_IN]->(r:Race)\n"+
                "WHERE toInteger(rel.position) = 1\n"+
                "RETURN d.forename + ' ' + d.surname AS driver, count(rel) AS wins ORDER BY wins DESC;",
            builtin: true
        },
        {
            name: "Number of teams per nationalilty",
            query: "MATCH (c:Constructor)\n"+
            "WITH c.nationality AS Nationality, COUNT(DISTINCT c) AS Num_of_constructors\n"+
            "CALL { MATCH (c2:Constructor)\n"+
                "RETURN COUNT(DISTINCT c2) AS total}\n"+
                "RETURN Nationality, Num_of_constructors as `Number of teams`, ROUND(100.0 * Num_of_constructors / total, 2) AS `Percentage(%)`" +
                "ORDER BY Num_of_constructors DESC" +
                "LIMIT 10",
            builtin: true
        },
        {
            name: "Drivers with > 150 races",
            query: "MATCH (d:Driver)-[:RESULTS_IN]->(r:Race)\n" +
            "WITH d, COUNT(r) AS Num_races\n" +
                "WHERE Num_races > 150\n" +
                "RETURN d.forename + ' ' + d.surname AS Pilot, Num_races AS `Number of races until 2024`\n" +
                "ORDER BY Num_races DESC",
            builtin: true
        },
        {
            name: "Pilots who won their first GP - the fastest",
            query: "MATCH (d:Driver)-[r:RESULTS_IN]->(ra:Race) WHERE ra.date IS NOT NULL " +
                "WITH d, r, ra, split(ra.date, '/') AS p " +
                "WITH d, r, ra, date(p[2] + '-' + p[1] + '-' + p[0]) AS raceDate " +
                "ORDER BY d.driverId, raceDate ASC " +
                "WITH d, collect({race: ra, date: raceDate, pos: coalesce(toString(r.position), toString(r.positionOrder))}) AS races " +
                "WITH d, races[0] AS debut, [x IN races " +
                "WHERE x.pos = '1'][0] AS firstWin, races AS allRaces " +
                "WHERE firstWin IS NOT NULL " +
                "WITH d, debut, firstWin, allRaces, apoc.coll.indexOf(allRaces, debut) AS debutIndex, apoc.coll.indexOf(allRaces, firstWin) AS winIndex " +
                "WITH d, debut, firstWin, (winIndex - debutIndex + 1) AS `Races To Win`, duration.inDays(debut.date, firstWin.date).days AS `Days To First Win` " +
                "RETURN d.forename + ' ' + d.surname AS Driver, toString(debut.date.day) + '/' + toString(debut.date.month) + '/' + toString(debut.date.year) AS `Debut Date`, debut.race.name AS DebutGP, toString(firstWin.date.day) + '/' + toString(firstWin.date.month) + '/' + toString(firstWin.date.year) AS `First Win Date`," +
                " firstWin.race.name AS `First Win GP`, " +
                "`Days To First Win`, `Races To Win` " +
                "ORDER BY `Races To Win` ASC, `Days To First Win` ASC " +
                "LIMIT 25",
            builtin: true
        },
        {
            name: "Almost there - most podiums, least wins",
            query: "MATCH (d:Driver)-[r:RESULTS_IN]->(ra:Race)\n" +
                "WITH \n" +
                "  d, toInteger(r.position) AS pos\n" +
                "WITH \n" +
                "  d,\n" +
                "  COUNT(*) AS totalRaces,\n" +
                "  COUNT(CASE WHEN pos <= 3 THEN 1 END) AS podiums,\n" +
                "  COUNT(CASE WHEN pos = 1 THEN 1 END) AS wins\n" +
                "WHERE podiums > 0 AND wins < podiums\n" +
                "RETURN\n" +
                "  d.forename + ' ' + d.surname AS Driver,\n" +
                "  d.nationality as Nationality,\n" +
                "  wins AS Wins,\n" +
                "  podiums AS Podiums,\n" +
                "  totalRaces AS `Total races`,\n" +
                "  round(100.0 * podiums / totalRaces, 1) AS `Podium % rate`\n" +
                "ORDER BY Wins ASC, Podiums DESC\n" +
                "LIMIT 20",
            builtin: true
        },
        {
            name: "Remuntada - best wins after worst grid position",
            query: "MATCH (d:Driver)-[res:RESULTS_IN]->(ra:Race)-[:HELD_AT]->(c:Circuit)\n" +
                   "WHERE toInteger(res.position) = 1\n" +
                   "AND res.grid IS NOT NULL\n" +
                   "AND res.grid <> '\N'\n" +
                 "WITH d, ra, c, toInteger(res.grid) AS startPos, toInteger(res.position) AS endPos\n" +
                 "ORDER BY startPos DESC\n" +
                 "LIMIT 10\n" +
                 "RETURN\n" +
                 "  d.forename +' ' + d.surname AS Driver,\n" +
                 "  ra.name + ' ' (''+ ra.year + '')'' AS Race,\n" +
                 "  startPos AS `Starting grid position`,\n" +
                 "  endPos AS `Final position`,\n" +
                 "  (startPos - endPos) AS `Positions gained`;\n",
            builtin: true
        },
        {
            name: "Sherpa races - highest circuits",
            query: "MATCH (c:Circuit)\n" +
                "WHERE c.alt IS NOT NULL\n" +
                "WITH c, toInteger(c.alt) AS altitude\n" +
                "ORDER BY altitude DESC\n" +
                "LIMIT 3\n" +
                "RETURN \n" +
                "  c.name AS Circuit,\n" +
                "  c.country AS `Country`,\n" +
                "  altitude AS `Altitude (ASL)`",
            builtin: true
        },
        {
            name: "Seniority - drivers that ran in more seasons",
            query: "MATCH (d:Driver)-[:RESULTS_IN]->(ra:Race)\n" +
                "WITH d, COLLECT(DISTINCT ra.year) AS seasons\n" +
                "RETURN \n" +
                "  d.forename + ' ' + d.surname AS Driver,\n" +
                "  SIZE(seasons) AS `Number of seasons`,\n" +
                "  seasons AS `Season list`\n" +
                "ORDER BY `Number of seasons` DESC\n" +
                "LIMIT 5",
            builtin: true
        },
        {
            name: "No room for romance - drivers with more teams",
            query: "MATCH (d:Driver)-[r:RESULTS_IN]->(ra:Race)\n" +
                "MATCH (c:Constructor)\n" +
                "WHERE toInteger(r.constructorId) = toInteger(c.constructorId)\n" +
                "WITH d, COLLECT(DISTINCT c.name) AS Teams\n" +
                "RETURN \n" +
                "  d.forename + ' ' + d.surname AS Driver,\n" +
                "  SIZE(Teams) AS `Number of teams`,\n" +
                "  Teams AS `Team list`\n" +
                "ORDER BY `Number of teams` DESC\n" +
                "LIMIT 5",
            builtin: true
        },
        {
            name: "Related drivers,",
            query: "MATCH (d:Driver)\n" +
                "WITH d LIMIT 1\n" +
                "MERGE (d)-[r:RELATED_TO {\n" +
                "  driverId1: '',\n" +
                "  relationship: '',\n" +
                "  driverId2: ''\n" +
                "}]->(d)",
            builtin: true
        },
        {
            name: "Insert new driver",
            query: "CREATE (:Driver {\n" +
                "  forename: \"\"Kimi\"\",\n" +
                "  surname: \"\"Antonelli\"\",\n" +
                "  dob: date(\"\"2006-08-25\"\"),\n" +
                "  nationality: \"\"Italian\"\",\n" +
                "  driverRef: \"\"antonelli\"\",\n" +
                "  driverId: 863,\n" +
                "  number: 12,\n" +
                "  code: \"\"ANT\"\"})",
            builtin: true
        },
        {
            name: "Create nickname",
            query: "CREATE (n:Driver_nick {\n" +
                "  driverId: '',\n" +
                "  nickname: '',\n" +
                "  definition: ''\n" +
                "})\n" +
                "WITH n\n" +
                "MATCH (d:Driver)\n" +
                "WITH d, n LIMIT 1\n" +
                "MERGE (d)-[r:HAS_NICKNAME]->(n)\n",
            builtin: true
        },
        {
            name: "INDEX_1",
            query: "CREATE INDEX driver_forename_index IF NOT EXISTS\n" +
                "FOR (d:Driver)\n" +
                "ON (d.forename);\n",
            builtin: true
        },
        {
            name: "INDEX_2",
            query: "CREATE INDEX driver_surname_index IF NOT EXISTS\n" +
                "FOR (d:Driver)\n" +
                "ON (d.surname);",
            builtin: true
        },
        {
            name: "INDEX_3",
            query: "CREATE INDEX race_id_index IF NOT EXISTS\n" +
                "FOR (r:Race)\n" +
                "ON (r.raceId);",
            builtin: true
        }
    ];

    /* ======================= MAIN APP ======================= */
    function App() {
        const [showChart, setShowChart] = useState(false);
        const [dark, setDark] = useState(() => localStorage.getItem("neo4j.darkMode") !== "false");
        const [isConnected, setConnected] = useState(false);
        const [cfg, setCfg] = useState(() => {
            const saved = localStorage.getItem("neo4j.cfg");
            return saved ? JSON.parse(saved) : { uri: "", username: "neo4j", password: "" };
        });
        const [showCfg, setShowCfg] = useState(false);
        const [query, setQuery] = useState("MATCH (n) RETURN n LIMIT 25");
        const [results, setResults] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [toast, setToast] = useState(null);

        // Saved queries (user + builtin)
        const [savedQueries, setSavedQueries] = useState(() => {
            const saved = localStorage.getItem("neo4j.savedQueries");
            return saved ? JSON.parse(saved) : [];
        });

        const allQueries = useMemo(() => [...defaultQueries, ...savedQueries], [savedQueries]);

        /* Persist settings */
        useEffect(() => localStorage.setItem("neo4j.darkMode", String(dark)), [dark]);
        useEffect(() => localStorage.setItem("neo4j.cfg", JSON.stringify(cfg)), [cfg]);
        useEffect(() => localStorage.setItem("neo4j.savedQueries", JSON.stringify(savedQueries)), [savedQueries]);

        /* Ctrl+Enter to run */
        useEffect(() => {
            const h = e => { if (e.ctrlKey && e.key === "Enter") { e.preventDefault(); executeQuery(); } };
            window.addEventListener("keydown", h);
            return () => window.removeEventListener("keydown", h);
        }, [query, isConnected]);

        /* Save current query */
        const saveCurrentQuery = () => {
            const name = prompt("Query:");
            if (!name || !name.trim()) return;

            const newQuery = {
                name: name.trim(),
                query: query,
                builtin: false,
                id: Date.now()
            };

            setSavedQueries(prev => [...prev, newQuery]);
            setToast({ type: "success", message: "Query saved!" });
        };

        /* Delete saved query */
        const deleteQuery = (id) => {
            if (confirm("Confirm query deletion?")) {
                setSavedQueries(prev => prev.filter(q => q.id !== id));
                setToast({ type: "info", message: "Query deleted" });
            }
        };

        /* Export queries as JSON */
        const exportQueries = () => {
            const data = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                queries: savedQueries
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `neo4j-queries-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            setToast({ type: "success", message: "Query exported!" });
        };

        /* Import queries from JSON */
        const importQueries = () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "application/json";
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.queries && Array.isArray(data.queries)) {
                            const imported = data.queries.map(q => ({
                                ...q,
                                id: Date.now() + Math.random(),
                                builtin: false
                            }));
                            setSavedQueries(prev => [...prev, ...imported]);
                            setToast({ type: "success", message: `Imported ${imported.length} query` });
                        } else {
                            setToast({ type: "error", message: "File JSON not valid" });
                        }
                    } catch (err) {
                        setToast({ type: "error", message: "File Error" });
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        /* Connect handler */
        const connect = async () => {
            if (!cfg.uri || !cfg.password) {
                setError("Insert URI and password");
                setToast({ type: "error", message: "Missing URI/Password " });
                return;
            }
            setLoading(true); setError("");
            try {
                const res = await fetch("/api/neo4j/connect", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(cfg)
                });
                const data = await res.json();
                if (data.connected) {
                    setConnected(true);
                    setShowCfg(false);
                    setToast({ type: "success", message: "Connected to database" });
                } else {
                    const msg = data.error || "Connession failure";
                    setError(msg);
                    setToast({ type: "error", message: msg });
                }
            } catch (e) {
                setError(String(e));
                setToast({ type: "error", message: "Connection Error" });
            } finally {
                setLoading(false);
            }
        };

        const disconnect = () => {
            setConnected(false);
            setResults(null);
            setToast({ type: "info", message: "Disconnected" });
        };

        /* Execute query */
        const executeQuery = useCallback(async () => {
            if (!query.trim()) {
                setToast({ type: "error", message: "Insert your Query" });
                return;
            }
            setLoading(true); setError("");
            const start = performance.now();
            try {
                const res = await fetch("/api/neo4j/query", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query })
                });
                const end = performance.now();
                const ms = Math.max(0, Math.round(end - start));

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const msg = err.error || "QueryError";
                    setError(msg);
                    setResults(null);
                    setToast({ type: "error", message: msg });
                } else {
                    const data = await res.json();
                    setResults({
                        columns: data.columns || [],
                        data: data.data || [],
                        executionTime: data.executionTime ?? ms
                    });
                    setToast({ type: "success", message: `Performed in ${data.executionTime ?? ms} ms` });
                }
            } catch (e) {
                setError(String(e));
                setResults(null);
                setToast({ type: "error", message: "Execution Error" });
            } finally {
                setLoading(false);
            }
        }, [query]);

        const bg = dark
            ? "bg-gradient-to-br from-slate-950 via-blue-950 to-slate-950 text-slate-100"
            : "bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 text-gray-900";
        const panel = dark ? "bg-slate-900/90 border-slate-700/60" : "bg-white border-gray-200";
        const input = dark ? "bg-slate-900 border-slate-700 text-white placeholder-slate-400" : "bg-white border-gray-300 text-gray-900 placeholder-gray-400";

        return (
            <div className={`min-h-screen w-full ${bg} transition-colors`}>
                {/* Toast */}
                {toast && <Toast {...toast} onClose={() => setToast(null)} />}

                <header className="max-w-7xl mx-auto px-6 py-6">
                    <div className="flex items-center justify-between">

                        {/* 🔥 Nuovo header grafico */}
                        <div className="flex items-center gap-4 animate-fade-slide">
                            <div className="p-3 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-2xl shadow-lg shadow-blue-500/20">
                                <Icon path={paths.db} className="w-8 h-8 text-white" />
                            </div>
                            <div>
                                <h1 className="text-4xl font-extrabold tracking-tight bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent drop-shadow-[0_0_10px_rgba(59,130,246,0.3)]">
                                    Neo4j Query Hub
                                </h1>
                                <p className="text-sm text-gray-400 mt-1">Explore F1 Data Visually</p>
                            </div>
                        </div>

                        {/* Pulsanti di destra restano invariati */}
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setDark(v => !v)}
                                className={`px-3 py-2 rounded-lg border ${dark ? "border-yellow-400/40 bg-yellow-400/10" : "border-indigo-400/40 bg-indigo-100"}`}
                                title="Toggle tema"
                            >
                                <Icon path={dark ? paths.sun : paths.moon} className="w-5 h-5" />
                            </button>

                            {isConnected ? (
                                <button
                                    onClick={disconnect}
                                    className={`px-4 py-2 rounded-lg border ${dark ? "bg-red-500/15 border-red-400 text-red-300" : "bg-red-100 border-red-300 text-red-700"}`}
                                >
                                    Disconnetti
                                </button>
                            ) : (
                                <button
                                    onClick={() => setShowCfg(s => !s)}
                                    className={`flex items-center gap-2 px-5 py-2 rounded-lg font-medium shadow hover:shadow-md transition ${
                                        dark ? "bg-gradient-to-r from-blue-500 to-purple-600" : "bg-gradient-to-r from-blue-500 to-purple-600 text-white"
                                    }`}
                                >
                                    <Icon path={paths.settings} className="w-5 h-5" />
                                    Configura/Connetti
                                </button>
                            )}
                        </div>
                    </div>
                </header>


                <main className="max-w-7xl mx-auto px-6 pb-12">
                    {/* CONFIG */}
                    {showCfg && (
                        <div className={`border rounded-2xl p-6 mb-6 backdrop-blur animate-fade-in ${panel}`}>
                            <h2 className="text-xl font-semibold mb-4">Configurazione Neo4j Aura</h2>
                            <div className="grid md:grid-cols-3 gap-4">
                                <input
                                    type="text" placeholder="neo4j+s://xxxxx.databases.neo4j.io"
                                    className={`w-full px-4 py-3 rounded-xl border ${input}`}
                                    value={cfg.uri} onChange={e => setCfg({ ...cfg, uri: e.target.value })}
                                />
                                <input
                                    type="text" placeholder="Username" className={`w-full px-4 py-3 rounded-xl border ${input}`}
                                    value={cfg.username} onChange={e => setCfg({ ...cfg, username: e.target.value })}
                                />
                                <input
                                    type="password" placeholder="Password" className={`w-full px-4 py-3 rounded-xl border ${input}`}
                                    value={cfg.password} onChange={e => setCfg({ ...cfg, password: e.target.value })}
                                />
                            </div>
                            <div className="mt-4 flex gap-3">
                                <button
                                    onClick={connect} disabled={loading}
                                    className={`px-6 py-3 rounded-xl font-medium shadow hover:shadow-md transition ${dark ? "bg-emerald-600/90" : "bg-emerald-600 text-white"}`}
                                >
                                    {loading ? "Connection..." : "Connected to Database"}
                                </button>
                                <button
                                    onClick={() => setShowCfg(false)}
                                    className={`px-4 py-3 rounded-xl border ${dark ? "border-slate-700" : "border-gray-300"}`}
                                >Chiudi</button>
                            </div>
                        </div>
                    )}

                    {/* WELCOME */}
                    {!isConnected && !showCfg && (
                        <div className="min-h-screen flex flex-col items-center justify-center text-white bg-flow transition-all duration-1000">
                            <div className="backdrop-blur-xl bg-white/10 border border-white/10 shadow-2xl rounded-3xl p-6">
                                <div className={`text-center py-24 px-8 border rounded-2xl backdrop-blur-xl shadow-2xl ${dark ? "bg-slate-900/80 border-slate-700/60" : "bg-white/70 border-gray-200/70"} animate-fade-in`}>
                                <Icon path={paths.db} className="w-16 h-16 mx-auto mb-6 text-blue-400 drop-shadow-lg animate-pulse"/>
                                <h3 className="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                                    Welcome in F1 Query Interface
                                </h3>
                                <p className="text-base text-gray-300 mb-8">
                                    Connect to yor database and start exploring data about Formula 1
                                </p>
                                <button
                                    onClick={() => setShowCfg(true)}
                                    className="px-8 py-3 rounded-xl font-semibold bg-gradient-to-r from-blue-500 to-purple-600 hover:scale-105 transition-transform shadow-md"
                                >
                                    🚀 Connection Configuration
                                </button>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* QUERY AREA */}
                    {isConnected && (
                        <div className="grid md:grid-cols-12 gap-6">
                            {/* Sidebar saved queries */}
                            <aside className={`md:col-span-4 p-5 border rounded-2xl h-fit ${panel} animate-slide-up`}>
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-semibold">Query Salvate</h4>
                                    <div className="flex gap-1">
                                        <button
                                            onClick={importQueries}
                                            className={`p-1.5 rounded-lg border text-xs ${dark ? "border-slate-700 hover:bg-slate-800" : "border-gray-300 hover:bg-gray-50"}`}
                                            title="Import query from JSON"
                                        >
                                            <Icon path={paths.upload} className="w-4 h-4"/>
                                        </button>
                                        <button
                                            onClick={exportQueries}
                                            disabled={savedQueries.length === 0}
                                            className={`p-1.5 rounded-lg border text-xs ${dark ? "border-slate-700 hover:bg-slate-800 disabled:opacity-30" : "border-gray-300 hover:bg-gray-50 disabled:opacity-30"}`}
                                            title="Export query as JSON"
                                        >
                                            <Icon path={paths.download} className="w-4 h-4"/>
                                        </button>
                                        <button
                                            onClick={saveCurrentQuery}
                                            className={`p-1.5 rounded-lg border text-xs ${dark ? "border-emerald-700 bg-emerald-900/20 hover:bg-emerald-900/40" : "border-emerald-300 bg-emerald-50 hover:bg-emerald-100"}`}
                                            title="Current query: Saved"
                                        >
                                            <Icon path={paths.plus} className="w-4 h-4"/>
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-2 max-h-[600px] overflow-y-auto pr-1">
                                    {allQueries.length === 0 && (
                                        <p className={`${dark ? "text-slate-400" : "text-gray-500"} text-sm text-center py-8`}>
                                            Nessuna query salvata
                                        </p>
                                    )}
                                    {allQueries.map((q, i) => (
                                        <div
                                            key={q.id || i}
                                            className={`group relative px-3 py-2 rounded-lg border transition ${
                                                dark ? "hover:bg-slate-800/70 border-slate-700" : "hover:bg-gray-50 border-gray-200"
                                            }`}
                                        >
                                            <button
                                                onClick={() => setQuery(q.query)}
                                                className="w-full text-left"
                                            >
                                                <span className="text-sm font-medium block">{q.name}</span>
                                                <div className={`${dark ? "text-slate-400" : "text-gray-500"} text-xs line-clamp-1 mt-1`}>
                                                    {q.query}
                                                </div>
                                            </button>
                                            {!q.builtin && (
                                                <button
                                                    onClick={() => deleteQuery(q.id)}
                                                    className={`absolute top-2 right-2 p-1 rounded opacity-0 group-hover:opacity-100 transition ${
                                                        dark ? "hover:bg-red-500/20 text-red-400" : "hover:bg-red-100 text-red-600"
                                                    }`}
                                                    title="Delete"
                                                >
                                                    <Icon path={paths.trash} className="w-3.5 h-3.5"/>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </aside>

                            {/* Editor + Results */}
                            <section className="md:col-span-8 space-y-6">
                                {/* Editor */}
                                <div className={`p-5 border rounded-2xl ${panel} animate-slide-up`}>
                                    <div className="flex items-center justify-between mb-3">
                                        <h4 className="font-semibold">Cypher Query Editor</h4>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={saveCurrentQuery}
                                                className={`px-3 py-2 rounded-lg border text-sm ${dark ? "border-emerald-700 bg-emerald-900/20 hover:bg-emerald-900/40" : "border-emerald-300 bg-emerald-50 hover:bg-emerald-100"}`}
                                                title="Salva query"
                                            >
                                                <Icon path={paths.save} className="w-4 h-4 inline mr-1"/>Salva
                                            </button>
                                            <button
                                                onClick={() => setQuery("")}
                                                className={`px-3 py-2 rounded-lg border text-sm ${dark ? "border-slate-700 hover:bg-slate-800/70" : "border-gray-300 hover:bg-gray-50"}`}
                                                title="Clean Editor"
                                            >
                                                <Icon path={paths.trash} className="w-4 h-4 inline mr-1"/>Clear
                                            </button>
                                            <button
                                                onClick={executeQuery} disabled={loading}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium shadow hover:shadow-md transition ${
                                                    dark ? "bg-emerald-600/90" : "bg-emerald-600 text-white"
                                                }`}
                                                title="Ctrl + Enter"
                                            >
                                                <Icon path={paths.play} className="w-4 h-4 inline mr-2"/>Esegui
                                            </button>
                                        </div>
                                    </div>
                                    <textarea
                                        value={query}
                                        onChange={e => setQuery(e.target.value)}
                                        onInput={e => { e.target.style.height = "auto"; e.target.style.height = e.target.scrollHeight + "px"; }}
                                        placeholder="MATCH (n:Driver) RETURN n LIMIT 25"
                                        className={`w-full min-h-[140px] px-4 py-3 rounded-xl font-mono text-sm resize-none border ${input}`}
                                        spellCheck="false"
                                    />
                                    <div className={`${dark ? "text-slate-500" : "text-gray-500"} text-xs mt-2`}>
                                        Suggerimento: <kbd className="px-1 py-0.5 border rounded">Ctrl</kbd> + <kbd className="px-1 py-0.5 border rounded">Enter</kbd> per eseguire
                                    </div>
                                </div>

                                {/* Loading (🏎️ Formula 1 Animation) */}
                                {loading && (
                                    <div className={`py-16 border rounded-2xl ${panel} animate-fade-in text-center relative overflow-hidden`}>
                                        <div className="relative w-full max-w-xl mx-auto h-24 mt-4">
                                            {/* Race Track */}
                                            <div className="absolute bottom-6 left-0 w-full h-3 bg-gradient-to-r from-gray-600 via-gray-500 to-gray-600 rounded-full overflow-hidden">
                                                <div className="absolute inset-0 bg-[linear-gradient(90deg,#222_25%,#666_25%,#666_50%,#222_50%,#222_75%,#666_75%,#666_100%)] bg-[length:40px_100%] animate-[trackMove_1s_linear_infinite]"></div>
                                            </div>

                                            {/* F1 Car */}
                                            <div className="absolute left-0 bottom-1 animate-[carMove_2s_linear_infinite]">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 80" className="w-20 h-20">
                                                    <path d="M10 60 L50 60 L60 40 L100 40 L110 60 L150 60 L150 65 L10 65 Z" fill="#e10600" stroke="#700" strokeWidth="2"/>
                                                    <circle cx="30" cy="65" r="8" fill="black"/>
                                                    <circle cx="130" cy="65" r="8" fill="black"/>
                                                    <rect x="65" y="35" width="15" height="8" fill="silver" rx="2"/>
                                                    <rect x="80" y="38" width="8" height="5" fill="black"/>
                                                    <circle cx="90" cy="42" r="2" fill="white"/>
                                                </svg>
                                            </div>

                                            {/* Exhaust Smoke */}
                                            <div className="absolute bottom-4 left-[-20px] flex gap-2 animate-[smokeLoop_2s_linear_infinite]">
                                                <div className="w-2 h-2 bg-gray-400/60 rounded-full animate-[smokePuff_2s_ease-in-out_infinite]"></div>
                                                <div className="w-2 h-2 bg-gray-400/60 rounded-full animate-[smokePuff_2s_ease-in-out_infinite_1s]"></div>
                                                <div className="w-2 h-2 bg-gray-400/60 rounded-full animate-[smokePuff_2s_ease-in-out_infinite_1.5s]"></div>
                                            </div>
                                        </div>

                                        <p className={`${dark ? "text-slate-400" : "text-gray-600"} mt-16 font-medium italic`}>
                                            Esecuzione in corso... <span className="inline-block animate-pulse">🏁</span>
                                        </p>
                                    </div>
                                )}


                                {/* Error */}
                                {error && !loading && (
                                    <div className={`p-4 border rounded-2xl ${dark ? "bg-red-500/10 border-red-500/40 text-red-300" : "bg-red-50 border-red-300 text-red-700"} animate-fade-in`}>
                                        <Icon path={paths.x} className="w-5 h-5 inline mr-2"/> {error}
                                    </div>
                                )}

                                {results && !loading && (
                                    <div
                                        className={`border rounded-2xl overflow-hidden shadow-xl transition-all duration-500 ${panel} animate-fade-in`}
                                    >
                                        {/* Header risultati */}
                                        <div
                                            className={`flex items-center justify-between px-6 py-4 border-b backdrop-blur-sm ${
                                                dark
                                                    ? "border-slate-700/60 bg-slate-950/30"
                                                    : "border-gray-200 bg-white/50"
                                            }`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div
                                                    className={`p-2.5 rounded-xl ${
                                                        dark
                                                            ? "bg-emerald-500/10 text-emerald-400"
                                                            : "bg-emerald-100 text-emerald-700"
                                                    }`}
                                                >
                                                    <Icon path={paths.check} className="w-5 h-5" />
                                                </div>
                                                <div>
                                                    <h5 className="font-semibold text-lg">Risultati Query</h5>
                                                    <p className={`text-xs ${dark ? "text-slate-400" : "text-gray-500"}`}>
                                                        Query eseguita con successo
                                                    </p>
                                                </div>
                                            </div>

                                            <div
                                                className={`text-sm flex items-center gap-4 ${
                                                    dark ? "text-slate-400" : "text-gray-600"
                                                }`}
                                            >
        <span className="inline-flex items-center gap-1.5">
          <Icon path={paths.clock} className="w-4 h-4" />
            {results.executionTime} ms
        </span>
                                                <span className="inline-flex items-center gap-1.5">
          <Icon path={paths.bolt} className="w-4 h-4" />
                                                    {results.data.length} righe
        </span>
                                                <span className="inline-flex items-center gap-1.5">
          <Icon path={paths.db} className="w-4 h-4" />
                                                    {results.columns.length} colonne
        </span>
                                                <button
                                                    className={`px-3 py-1 rounded-lg border text-sm font-medium transition hover:scale-[1.03] active:scale-[0.97] ${
                                                        dark
                                                            ? "border-blue-400/40 hover:bg-blue-500/10 text-blue-300"
                                                            : "border-blue-300 hover:bg-blue-50 text-blue-700"
                                                    }`}
                                                    onClick={() => {
                                                        const blob = new Blob([JSON.stringify(results, null, 2)], {
                                                            type: "application/json",
                                                        });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement("a");
                                                        a.href = url;
                                                        a.download = "neo4j-results.json";
                                                        a.click();
                                                        URL.revokeObjectURL(url);
                                                        setToast({ type: "success", message: "Esportato JSON" });
                                                    }}
                                                >
                                                    <Icon path={paths.download} className="w-4 h-4 inline mr-1" />
                                                    Esporta JSON
                                                </button>
                                            </div>
                                        </div>

                                        {/* Tabella risultati */}
                                        <div className="overflow-x-auto relative">
                                            <table className="w-full border-collapse">
                                                <thead
                                                    className={`sticky top-0 z-10 ${
                                                        dark ? "bg-slate-900/90" : "bg-gray-100/95"
                                                    } backdrop-blur-sm`}
                                                >
                                                <tr>
                                                    {results.columns.map((c, i) => (
                                                        <th
                                                            key={i}
                                                            className={`px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b ${
                                                                dark
                                                                    ? "border-slate-800 text-blue-300"
                                                                    : "border-gray-300 text-blue-700"
                                                            }`}
                                                        >
                                                            {c}
                                                        </th>
                                                    ))}
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {results.data.length === 0 && (
                                                    <tr>
                                                        <td
                                                            className="px-6 py-6 text-center text-sm opacity-70"
                                                            colSpan={results.columns.length}
                                                        >
                                                            No result
                                                        </td>
                                                    </tr>
                                                )}
                                                {results.data.map((row, rIdx) => (
                                                    <tr
                                                        key={rIdx}
                                                        className={`transition-colors ${
                                                            dark
                                                                ? "border-t border-slate-800/60 hover:bg-slate-900/50"
                                                                : "border-t border-gray-200 hover:bg-blue-50/30"
                                                        }`}
                                                    >
                                                        {results.columns.map((col, cIdx) => (
                                                            <td
                                                                key={cIdx}
                                                                className="px-6 py-3 align-top text-sm font-mono break-all"
                                                            >
                                                                {typeof row[col] === "object" && row[col] !== null ? (
                                                                    <JsonCell value={row[col]} dark={dark} />
                                                                ) : (
                                                                    (row[col] ?? "-").toString()
                                                                )}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </section>
                        </div>
                    )}
                    </main>
                    <footer className="max-w-7xl mx-auto px-6 py-8 opacity-70 text-sm">
                    <div className="flex flex-wrap items-center gap-3 justify-between">
                        <span>© {new Date().getFullYear()} Neo4j Query Hub</span>
                        <span className={`${dark ? "text-slate-400" : "text-gray-600"}`}>Suggerimento: usa query salvate nella sidebar per partire più veloce</span>
                    </div>
                </footer>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
